<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- For Mobile Devices -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<title>Boost.SIMD: Sum of Arrays</title>
<!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="doxy-boot.js"></script>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
<div class="container">
<div class="navbar-header responsive-logo">
<a class="navbar-brand" style="width: 10%" href="https://github.com/NumScale/boost.simd">Boost.SIMD </a>
<a href="http://numscale.implicitweb.fr/" title="Numscale" style="display: block; width: 25%; text-align: right; float: right"><img src="numscale.png" alt="Numscale" style="width:100%; padding-top: 10px; padding-bottom: 10px; " align="right"></a>
</div>
</div>
</nav>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div class="content" id="content">
<div class="container">
<div class="row">
<div class="col-sm-12 panel " style="padding-bottom: 35px;">
<div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="QuickStart.html"><span>Quick&#160;Start</span></a></li>
      <li><a href="tutorials.html"><span>Tutorials</span></a></li>
      <li><a href="modules.html"><span>Reference&#160;documentation</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Sum of Arrays </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="tutorial-hello.html">SIMD HelloWorld</a></li>
<li><a class="el" href="tutorial-sum.html">Sum of Arrays</a></li>
<li><a class="el" href="tutorial-reduction.html">Reductions</a></li>
<li><a class="el" href="tutorial-data.html">Processing Data the SIMD Way</a></li>
<li><a class="el" href="tutorial-runtime.html">Runtime Extension Selection</a></li>
</ul>
<p>This tutorial presents the different ways to fill and use a <a class="el" href="classboost_1_1simd_1_1pack.html" title="High-level interface for manipulating SIMD data. ">boost::simd::pack</a> in a more realistic use case than above.</p>
<p>The following methods will show different ways to vectorize the following scalar code computing the difference between an array and a constant.</p>
<div class="fragment"><div class="line">  <span class="comment">// Scalar version</span></div><div class="line">  <span class="keywordflow">for</span> ( <span class="keywordtype">size_t</span> i = 0 ; i &lt; size ; ++i )</div><div class="line">    out[i] = array[i] - 128;</div></div><!-- fragment --><p> In order to take advantage of <b>Boost.SIMD</b>, we will use the <a class="el" href="namespaceboost_1_1simd_a44f9b5b1a343b238a3a80a52365ec860.html#a44f9b5b1a343b238a3a80a52365ec860" title="Load a value from memory into a generic variable. ">boost::simd::load</a> and <a class="el" href="namespaceboost_1_1simd_af50789733f52bd58296f90d91b5b3b3e.html#af50789733f52bd58296f90d91b5b3b3e" title="Store a value at an arbitrary memory location. ">boost::simd::store</a> functions to load data into the pack and store it back into memory.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/load.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/store.hpp&gt;</span></div></div><!-- fragment --><p> The simplest approach, exclusive to arrays whose sizes are powers of 2, is to load the full array into a pack the size of the array.</p>
<div class="fragment"><div class="line">  <span class="comment">// Using large packs</span></div><div class="line">  <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int,size&gt;</a> full_arr;</div><div class="line">  <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int,size&gt;</a> full_out;</div><div class="line">  <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int,size&gt;</a> full_128{128};</div><div class="line"></div><div class="line">  full_arr = bs::load&lt;bs::pack&lt;int,size&gt;&gt;(array);</div><div class="line">  full_out = full_arr - full_128;</div><div class="line">  <a class="code" href="namespaceboost_1_1simd_af5521b79da254d7133fa74cfaf547e10.html#af5521b79da254d7133fa74cfaf547e10">bs::store</a>(full_out , out);</div></div><!-- fragment --><p> This section loads the full input array into a pack and fills another pack with our constant. This allows us to perform the substraction directly on the full array with one line of code.</p>
<p>For arrays whose sizes are not clean multiples of 2, we must use smaller sized packs (or pad the length to the next power of 2). It is generally simplest to use the default pack size, corresponding to the size of the available physical <em>SIMD</em> registers. This size can be obtained using the <a class="el" href="structboost_1_1simd_1_1cardinal__of.html" title="Computes the register width required to store an instance of any type T. ">boost::simd::cardinal_of</a> function.</p>
<p>Note that we increment our loop by the number of elements in our pack because we are treating more than one element per loop iteration.</p>
<p>The last two <b>Boost.SIMD</b> implementations must take advantage of this cardinal size in order to properly iterate over the array. Both implementations must manually specify the memory address of the data to load into a pack, loading a few elements per loop iteration. For each loop iteration, we must load the array data into a <a class="el" href="classboost_1_1simd_1_1pack.html" title="High-level interface for manipulating SIMD data. ">boost::simd::pack</a>, perform the substraction between packs, then store the result into the output array.</p>
<p>There are two ways to load data into our packs:</p>
<ol type="1">
<li>By explicitly calling the <a class="el" href="namespaceboost_1_1simd_a44f9b5b1a343b238a3a80a52365ec860.html#a44f9b5b1a343b238a3a80a52365ec860" title="Load a value from memory into a generic variable. ">boost::simd::load</a> function <div class="fragment"><div class="line">  <span class="comment">// Using explicit load/store</span></div><div class="line">  ipack_t p_out;</div><div class="line">  ipack_t p_arr;</div><div class="line">  ipack_t one28{128};</div><div class="line">  <span class="keywordflow">for</span> ( <span class="keywordtype">size_t</span> i = 0 ; i &lt; size ; i += ipack_card ) {</div><div class="line">    p_out = bs::load&lt;ipack_t&gt;(out   + i);</div><div class="line">    p_arr = bs::load&lt;ipack_t&gt;(array + i);</div><div class="line">    p_out = p_arr - one28;</div><div class="line">    <a class="code" href="namespaceboost_1_1simd_af5521b79da254d7133fa74cfaf547e10.html#af5521b79da254d7133fa74cfaf547e10">bs::store</a>(p_out , out + i);</div><div class="line">  }</div></div><!-- fragment --></li>
<li>By constructing a <a class="el" href="classboost_1_1simd_1_1pack.html" title="High-level interface for manipulating SIMD data. ">boost::simd::pack</a> with a pointer towards the correct address <div class="fragment"><div class="line">  <span class="comment">// Using pointer construction</span></div><div class="line">  <span class="keywordflow">for</span> ( <span class="keywordtype">size_t</span> i = 0 ; i &lt; size ; i += ipack_card ) {</div><div class="line">    ipack_t p_out(out   + i);</div><div class="line">    ipack_t p_arr(array + i);</div><div class="line">    p_out = p_arr - one28;</div><div class="line">    <a class="code" href="namespaceboost_1_1simd_af5521b79da254d7133fa74cfaf547e10.html#af5521b79da254d7133fa74cfaf547e10">bs::store</a>(p_out , out + i);</div><div class="line">  }</div></div><!-- fragment --></li>
</ol>
<p>Here is the full compilable code for reference.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;boost/simd/pack.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/load.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/simd/function/store.hpp&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define size 256</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div><div class="line">  <span class="keyword">namespace </span><a class="code" href="namespaceboost_1_1simd.html">bs</a> = <a class="code" href="namespaceboost_1_1simd.html">boost::simd</a>;</div><div class="line">  <span class="keyword">using</span> ipack_t = <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int&gt;</a>;</div><div class="line">  <span class="keywordtype">size_t</span> ipack_card = <a class="code" href="structboost_1_1simd_1_1cardinal__of.html">bs::cardinal_of&lt;ipack_t&gt;</a>();</div><div class="line"></div><div class="line">  <span class="keywordtype">int</span> *array = <span class="keyword">new</span> <span class="keywordtype">int</span>[size];</div><div class="line">  <span class="keywordtype">int</span> *out   = <span class="keyword">new</span> <span class="keywordtype">int</span>[size];</div><div class="line"></div><div class="line">  <span class="comment">// Initialize input array</span></div><div class="line">  <span class="keywordflow">for</span> ( <span class="keywordtype">size_t</span> i = 0 ; i &lt; size ; ++i )</div><div class="line">    array[i] = i;</div><div class="line"></div><div class="line">  <span class="comment">// Scalar version</span></div><div class="line">  <span class="keywordflow">for</span> ( <span class="keywordtype">size_t</span> i = 0 ; i &lt; size ; ++i )</div><div class="line">    out[i] = array[i] - 128;</div><div class="line"></div><div class="line">  <span class="comment">// Using explicit load/store</span></div><div class="line">  ipack_t p_out;</div><div class="line">  ipack_t p_arr;</div><div class="line">  ipack_t one28{128};</div><div class="line">  <span class="keywordflow">for</span> ( <span class="keywordtype">size_t</span> i = 0 ; i &lt; size ; i += ipack_card ) {</div><div class="line">    p_out = bs::load&lt;ipack_t&gt;(out   + i);</div><div class="line">    p_arr = bs::load&lt;ipack_t&gt;(array + i);</div><div class="line">    p_out = p_arr - one28;</div><div class="line">    <a class="code" href="namespaceboost_1_1simd_af5521b79da254d7133fa74cfaf547e10.html#af5521b79da254d7133fa74cfaf547e10">bs::store</a>(p_out , out + i);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Using pointer construction</span></div><div class="line">  <span class="keywordflow">for</span> ( <span class="keywordtype">size_t</span> i = 0 ; i &lt; size ; i += ipack_card ) {</div><div class="line">    ipack_t p_out(out   + i);</div><div class="line">    ipack_t p_arr(array + i);</div><div class="line">    p_out = p_arr - one28;</div><div class="line">    <a class="code" href="namespaceboost_1_1simd_af5521b79da254d7133fa74cfaf547e10.html#af5521b79da254d7133fa74cfaf547e10">bs::store</a>(p_out , out + i);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Using large packs</span></div><div class="line">  <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int,size&gt;</a> full_arr;</div><div class="line">  <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int,size&gt;</a> full_out;</div><div class="line">  <a class="code" href="classboost_1_1simd_1_1pack.html">bs::pack&lt;int,size&gt;</a> full_128{128};</div><div class="line"></div><div class="line">  full_arr = bs::load&lt;bs::pack&lt;int,size&gt;&gt;(array);</div><div class="line">  full_out = full_arr - full_128;</div><div class="line">  <a class="code" href="namespaceboost_1_1simd_af5521b79da254d7133fa74cfaf547e10.html#af5521b79da254d7133fa74cfaf547e10">bs::store</a>(full_out , out);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --></div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
Generated on Fri Aug 12 2016 20:02:36 for Boost.SIMD by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>

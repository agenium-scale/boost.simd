<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- For Mobile Devices -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<title>Boost.SIMD: Processing Data the SIMD Way</title>
<!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="doxy-boot.js"></script>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
<div class="container">
<div class="navbar-header responsive-logo">
<a class="navbar-brand" style="width: 10%" href="https://github.com/NumScale/boost.simd">Boost.SIMD </a>
<a href="http://numscale.implicitweb.fr/" title="Numscale" style="display: block; width: 25%; text-align: right; float: right"><img src="numscale.png" alt="Numscale" style="width:100%; padding-top: 10px; padding-bottom: 10px; " align="right"></a>
</div>
</div>
</nav>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div class="content" id="content">
<div class="container">
<div class="row">
<div class="col-sm-12 panel " style="padding-bottom: 35px;">
<div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="QuickStart.html"><span>Quick&#160;Start</span></a></li>
      <li><a href="tutorials.html"><span>Tutorials</span></a></li>
      <li><a href="modules.html"><span>Reference&#160;documentation</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Processing Data the SIMD Way </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a class="el" href="tutorial-hello.html">SIMD HelloWorld</a></li>
<li><a class="el" href="tutorial-sum.html">Sum of Arrays</a></li>
<li><a class="el" href="tutorial-reduction.html">Reductions</a></li>
<li><a class="el" href="tutorial-data.html">Processing Data the SIMD Way</a></li>
<li><a class="el" href="tutorial-runtime.html">Runtime Extension Selection</a></li>
</ul>
<p>This tutorial will present how data can be processed using <b>Boost.SIMD</b> by writing a naive dot product using <b>Boost.SIMD</b>.</p>
<p>A simple sequential, scalar dot product can be simply defined as:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt; Value <a class="code" href="group__group-reduction_gaff8d315fafcf6c4112c2f1b2683da193.html#gaff8d315fafcf6c4112c2f1b2683da193">dot</a>(Value* first1, Value* last1, Value* first2)</div><div class="line">{</div><div class="line">  Value v(0);</div><div class="line"></div><div class="line">  <span class="keywordflow">while</span>(first1 != last1)</div><div class="line">  {</div><div class="line">    v += *first1 *  *first2;</div><div class="line">    first1++;</div><div class="line">    first2++;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> v;</div><div class="line">}</div></div><!-- fragment --><p> dot simply iterates over data pointed by first1 and first2, computes the product of said data and sum them along.</p>
<p><b>Transition from scalar to SIMD code</b></p>
<p>In this case the algorithm is clearly vectorizable, we shall modify it so that this becomes evident.</p>
<p>First, we unroll the loop arbitrarily showing the inherent data parallelism:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt; Value <a class="code" href="group__group-reduction_gaff8d315fafcf6c4112c2f1b2683da193.html#gaff8d315fafcf6c4112c2f1b2683da193">dot</a>(Value* first1, Value* last1, Value* first2)</div><div class="line">{</div><div class="line">  Value v1(0), v2(0);</div><div class="line"></div><div class="line">  <span class="keywordflow">while</span>(first1 != last1)</div><div class="line">  {</div><div class="line">    v1 += *first1 *  *first2;</div><div class="line">    first1++;</div><div class="line">    first2++;</div><div class="line"></div><div class="line">    v2 += *first1 *  *first2;</div><div class="line">    first1++;</div><div class="line">    first2++;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> v1 + v2;</div><div class="line">}</div></div><!-- fragment --><p> The algorithm is split into two parts:</p>
<p>First, we loop over each element inside both datasets and multiply them. Then, we sum the intermediate values into the final result. By unrolling this pattern arbitrarily, we expose the fact that the multiplication between the two dataset is purely "vertical" and so, is vectorizable. The sum of the partial results itself is a "horizontal" operation, i.e a vectorizable computation operating across the element of a single vector (see -register operation).</p>
<p><b>Building a SIMD loop</b></p>
<p>We are now going to use <a class="el" href="classboost_1_1simd_1_1pack.html" title="High-level interface for manipulating SIMD data. ">boost::simd::pack</a> to vectorize this loop. The main idea is to compute partial sums inside an instance of <a class="el" href="classboost_1_1simd_1_1pack.html" title="High-level interface for manipulating SIMD data. ">boost::simd::pack</a> and then perform a final summation. To do so, we will use <a class="el" href="namespaceboost_1_1simd_a44f9b5b1a343b238a3a80a52365ec860.html#a44f9b5b1a343b238a3a80a52365ec860" title="Load a value from memory into a generic variable. ">boost::simd::load</a> to load data from first1 and first2, process these <a class="el" href="classboost_1_1simd_1_1pack.html" title="High-level interface for manipulating SIMD data. ">boost::simd::pack</a> instances using the proper operators and advance the pointers by the size of the <a class="el" href="classboost_1_1simd_1_1pack.html" title="High-level interface for manipulating SIMD data. ">boost::simd::pack</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Value&gt;</div><div class="line">Value <a class="code" href="group__group-reduction_gaff8d315fafcf6c4112c2f1b2683da193.html#gaff8d315fafcf6c4112c2f1b2683da193">dot</a>(Value* first1, Value* last1, Value* first2)</div><div class="line">{</div><div class="line">  <span class="keyword">using</span> <a class="code" href="group__group-reduction_ga474846094a2e6c8f59ae86a1fc5cb720.html#ga474846094a2e6c8f59ae86a1fc5cb720">boost::simd::sum</a>;</div><div class="line">  <span class="keyword">using</span> <a class="code" href="classboost_1_1simd_1_1pack.html">boost::simd::pack</a>;</div><div class="line">  <span class="keyword">using</span> <a class="code" href="namespaceboost_1_1simd_a44f9b5b1a343b238a3a80a52365ec860.html#a44f9b5b1a343b238a3a80a52365ec860">boost::simd::load</a>;</div><div class="line"></div><div class="line">  <span class="keyword">typedef</span> pack&lt;Value&gt; type;</div><div class="line">  type tmp;</div><div class="line"></div><div class="line">  <span class="comment">// Let&#39;s assume that (last1-first1) is divisible by the size of the pack.</span></div><div class="line">  <span class="keywordflow">while</span>(first1 != last1)</div><div class="line">  {</div><div class="line">    <span class="comment">// Load current values from the datasets</span></div><div class="line">    pack&lt;Value&gt; x1 = load&lt; type &gt;(first1);</div><div class="line">    pack&lt;Value&gt; x2 = load&lt; type &gt;(first2);</div><div class="line"></div><div class="line">    <span class="comment">// Computation</span></div><div class="line">    tmp = tmp + x1 * x2;</div><div class="line"></div><div class="line">    <span class="comment">// Advance to the next SIMD vector</span></div><div class="line">    first1 += type::static_size;</div><div class="line">    first2 += type::static_size;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="group__group-reduction_ga474846094a2e6c8f59ae86a1fc5cb720.html#ga474846094a2e6c8f59ae86a1fc5cb720">sum</a>(tmp);</div><div class="line">}</div></div><!-- fragment --><p>That's it! Look at how similar the computation code is to the scalar version, we simply jump over data using a larger step size.</p>
<h1>Note:</h1>
<p>the code line <code>tmp = tmp + x1 * x2;</code> could have been replaced by <code>tmp += x1 * x2;</code> or even <code>tmp = fma(x1, x2,tmp);</code> (after having included <code><a class="el" href="fma_8hpp_source.html">boost/simd/function/fma.hpp</a></code>) which will lead to same code if hardware does not support fma, or even better code if it does.</p>
<p><b>Preparing the data</b></p>
<h1><a class="anchor" id="tutorial-shuffle"></a>
Memory Access</h1>
<hr/>
<h2>The result</h2>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
Generated on Fri Aug 12 2016 20:02:36 for Boost.SIMD by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
